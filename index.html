<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期末考看板 - 佈局修復穩定版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background-color: #f3f4f6; margin: 0; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* 核心佈局控制：確保三層絕對分離 */
        .layout-container {
            display: grid;
            grid-template-rows: 22vh 53vh 25vh; /* 上、中、下的高度固定百分比 */
            height: 100vh;
            width: 100vw;
        }

        /* 絲滑滑動動畫 */
        .message-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .slide-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1); text-align: center; width: 100%; }
        .slide-enter { transform: translateX(100%); opacity: 0; }
        .slide-active { transform: translateX(0); opacity: 1; }
        .slide-exit { transform: translateX(-100%); opacity: 0; }

        .big-time-input {
            background: transparent;
            font-size: 5.5vw;
            font-weight: 900;
            font-family: "Courier New", monospace;
            text-align: center;
            width: 180px; 
            outline: none;
            border-bottom: 4px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const DEFAULT_SCHEDULE = [
            { type: 'exam', start: '08:40', end: '09:20', subject: '國語' },
            { type: 'exam', start: '09:30', end: '10:10', subject: '數學' },
            { type: 'exam', start: '10:30', end: '11:10', subject: '英文' }
        ];

        const App = () => {
            const [now, setNow] = useState(new Date());
            const [offset, setOffset] = useState(() => Number(localStorage.getItem('exam_clock_offset')) || 0);
            const [schedule, setSchedule] = useState(() => JSON.parse(localStorage.getItem('exam_full_v17')) || DEFAULT_SCHEDULE);
            const [examData, setExamData] = useState(() => JSON.parse(localStorage.getItem('exam_data_v17')) || { shouldArrive: "", actualArrive: "", absentList: "" });
            const [messages, setMessages] = useState(() => JSON.parse(localStorage.getItem('exam_messages_v17')) || ["考卷記得寫姓名座號", "有問題請舉手問老師"]);
            const [msgIndex, setMsgIndex] = useState(0);

            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const msgTimer = setInterval(() => setMsgIndex((prev) => (prev + 1) % (messages.length || 1)), 20000);
                return () => clearInterval(msgTimer);
            }, [messages.length]);

            useEffect(() => {
                localStorage.setItem('exam_clock_offset', offset);
                localStorage.setItem('exam_full_v17', JSON.stringify(schedule));
                localStorage.setItem('exam_data_v17', JSON.stringify(examData));
                localStorage.setItem('exam_messages_v17', JSON.stringify(messages));
            }, [offset, schedule, examData, messages]);

            const adjustedNow = useMemo(() => new Date(now.getTime() + offset), [now, offset]);
            const formattedCurrentTime = useMemo(() => {
                return adjustedNow.toLocaleTimeString('zh-TW', { hour12: false });
            }, [adjustedNow]);

            const currentMs = adjustedNow.getHours() * 3600000 + adjustedNow.getMinutes() * 60000 + adjustedNow.getSeconds() * 1000;

            const currentSlot = useMemo(() => {
                for (let slot of schedule) {
                    const [sh, sm] = slot.start.split(':').map(Number);
                    const [eh, em] = slot.end.split(':').map(Number);
                    const startMs = (sh || 0) * 3600000 + (sm || 0) * 60000;
                    const endMs = (eh || 0) * 3600000 + (em || 0) * 60000;
                    if (currentMs >= startMs && currentMs < endMs) return { ...slot, startMs, endMs, duration: endMs - startMs, remaining: endMs - currentMs };
                }
                return null;
            }, [schedule, currentMs]);

            const handleTimeChange = (idx, field, val) => {
                const next = [...schedule];
                next[idx][field] = val.replace(/[^0-9:]/g, '');
                setSchedule(next);
            };

            return (
                <div className="layout-container">
                    
                    {/* 上方：系統時間區域 (22vh) */}
                    <header className="flex bg-white border-b-4 border-gray-300 shadow-md">
                        <div className="w-1/3 flex flex-col items-center justify-center bg-gray-50 border-r relative group">
                            <div className="text-[1.2vw] text-gray-400 font-bold uppercase">現在時間</div>
                            <div className="text-[7.5vw] font-black leading-none tabular-nums">{formattedCurrentTime}</div>
                        </div>
                        <div className="w-2/3 flex flex-col items-center justify-center p-4 bg-white relative">
                            <div className="text-[4vw] font-black text-gray-800">
                                {currentSlot ? currentSlot.subject : '準備/休息中'}
                            </div>
                            <div className="text-[1.8vw] font-bold text-gray-400">
                                {currentSlot ? `剩餘 ${Math.ceil(currentSlot.remaining/60000)} 分鐘` : '--'}
                            </div>
                        </div>
                    </header>

                    {/* 中間：考程與提醒事項 (53vh) */}
                    <main className="flex overflow-hidden">
                        {/* 左：科目列表 (70%) */}
                        <div className="w-[70%] bg-white border-r-4 border-gray-300 p-4 flex flex-col justify-center space-y-4">
                            {schedule.map((slot, i) => (
                                <div key={i} className={`flex items-center justify-between px-8 py-4 rounded-[2rem] border-4 ${currentSlot?.start === slot.start ? 'border-yellow-400 bg-yellow-50 shadow-lg' : 'border-gray-100 bg-gray-50'}`}>
                                    <input className="w-[30%] text-[4.5vw] font-black bg-transparent outline-none" value={slot.subject} onChange={(e) => { const n = [...schedule]; n[i].subject = e.target.value; setSchedule(n); }} />
                                    <div className="flex items-center gap-2">
                                        <input type="text" value={slot.start} onChange={(e) => handleTimeChange(i, 'start', e.target.value)} className="big-time-input text-blue-600" />
                                        <span className="text-gray-400 font-bold text-[3vw]">~</span>
                                        <input type="text" value={slot.end} onChange={(e) => handleTimeChange(i, 'end', e.target.value)} className="big-time-input text-gray-800" />
                                    </div>
                                </div>
                            ))}
                        </div>
                        {/* 右：提醒看板 (30%) */}
                        <div className="w-[30%] bg-[#fffdf0] p-4 flex flex-col overflow-hidden">
                            <div className="flex-1 bg-white border-4 border-dashed border-yellow-200 rounded-[2rem] relative overflow-hidden mb-4">
                                <div className="message-container">
                                    {messages.map((m, i) => {
                                        let status = i === msgIndex ? "slide-active" : (i < msgIndex ? "slide-exit" : "slide-enter");
                                        return <div key={i} className={`slide-text text-[3.2vw] font-black leading-tight text-gray-800 ${status}`}>{m}</div>;
                                    })}
                                </div>
                            </div>
                            <div className="h-[120px] overflow-y-auto bg-white/60 p-2 rounded-xl text-[12px] border">
                                <button onClick={()=>setMessages([...messages, "新內容"])} className="bg-yellow-500 text-white px-2 rounded mb-1">+ 新增</button>
                                {messages.map((m, i) => (
                                    <div key={i} className="flex gap-1 mb-1">
                                        <input className="flex-1 border p-1 rounded" value={m} onChange={(e)=>{const n=[...messages]; n[i]=e.target.value; setMessages(n);}} />
                                        <button onClick={()=>setMessages(messages.filter((_,idx)=>idx!==i))} className="text-red-400">✕</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>

                    {/* 下方：出缺席區域 (25vh) */}
                    <footer className="flex border-t-4 border-gray-300">
                        <div className="flex-1 flex flex-col items-center justify-center bg-blue-700 text-white border-r border-white/20">
                            <div className="text-[1.2vw] font-bold opacity-80 uppercase">應到人數</div>
                            <input type="number" className="w-full text-center bg-transparent text-[7vw] font-black outline-none" value={examData.shouldArrive} onChange={(e)=>setExamData({...examData, shouldArrive: e.target.value})} />
                        </div>
                        <div className="flex-1 flex flex-col items-center justify-center bg-green-700 text-white border-r border-white/20">
                            <div className="text-[1.2vw] font-bold opacity-80 uppercase">實到人數</div>
                            <input type="number" className="w-full text-center bg-transparent text-[7vw] font-black outline-none" value={examData.actualArrive} onChange={(e)=>setExamData({...examData, actualArrive: e.target.value})} />
                        </div>
                        <div className="flex-[1.2] flex flex-col items-center justify-center bg-red-700 text-white">
                            <div className="text-[1.2vw] font-bold opacity-80 uppercase">未到名單</div>
                            <textarea className="w-full h-full text-center bg-transparent text-[2.5vw] font-black outline-none resize-none pt-2" value={examData.absentList} onChange={(e)=>setExamData({...examData, absentList: e.target.value})} />
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期末考看板系統 - 穩定修復版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            overflow: hidden;
            background-color: #f3f4f6;
        }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        .track-transition { transition: stroke-dashoffset 1s linear, stroke 0.5s ease; }
        .text-shadow-lg { text-shadow: 3px 3px 6px rgba(0,0,0,0.15); }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* 確保時間輸入框不偏位 */
        .time-input-flat {
            background: transparent;
            border-bottom: 2px solid #d1d5db;
            outline: none;
            text-align: center;
            width: 140px;
        }
        .time-input-flat:focus {
            border-color: #3b82f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const DEFAULT_SCHEDULE = [
            { type: 'break', start: '08:30', end: '08:40', label: '準備' },
            { type: 'exam',  start: '08:40', end: '09:20', label: '第一節' },
            { type: 'break', start: '09:20', end: '09:30', label: '下課' },
            { type: 'exam',  start: '09:30', end: '10:10', label: '第二節' },
            { type: 'break', start: '10:10', end: '10:30', label: '下課 (大)' },
            { type: 'exam',  start: '10:30', end: '11:10', label: '第三節' },
            { type: 'break', start: '11:10', end: '11:20', label: '收卷' }
        ];

        const DEFAULT_MESSAGES = ["考卷記得寫班級姓名座號", "有問題舉手問老師", "不會寫的題目跳過寫會的", "耐心、細心、小心", "檢查完再檢查或趴下休息"];

        const App = () => {
            const [now, setNow] = useState(new Date());
            const [offset, setOffset] = useState(() => Number(localStorage.getItem('exam_clock_offset')) || 0);
            const [schedule, setSchedule] = useState(() => JSON.parse(localStorage.getItem('exam_schedule_v3')) || DEFAULT_SCHEDULE);
            const [messages, setMessages] = useState(() => JSON.parse(localStorage.getItem('exam_messages_v3')) || DEFAULT_MESSAGES);
            const [examData, setExamData] = useState(() => JSON.parse(localStorage.getItem('exam_data_v3')) || {
                subjects: ["國語", "數學", "英文"],
                shouldArrive: "", actualArrive: "", absentList: ""
            });

            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                localStorage.setItem('exam_clock_offset', offset);
                localStorage.setItem('exam_schedule_v3', JSON.stringify(schedule));
                localStorage.setItem('exam_messages_v3', JSON.stringify(messages));
                localStorage.setItem('exam_data_v3', JSON.stringify(examData));
            }, [offset, schedule, messages, examData]);

            const adjustedNow = useMemo(() => new Date(now.getTime() + offset), [now, offset]);
            const currentMs = useMemo(() => adjustedNow.getHours() * 3600000 + adjustedNow.getMinutes() * 60000 + adjustedNow.getSeconds() * 1000, [adjustedNow]);

            const currentSlot = useMemo(() => {
                for (let slot of schedule) {
                    const [sh, sm] = slot.start.split(':').map(Number);
                    const [eh, em] = slot.end.split(':').map(Number);
                    const startMs = sh * 3600000 + sm * 60000;
                    const endMs = eh * 3600000 + em * 60000;
                    if (currentMs >= startMs && currentMs < endMs) return { ...slot, startMs, endMs, duration: endMs - startMs, remaining: endMs - currentMs };
                }
                return null;
            }, [schedule, currentMs]);

            const progress = useMemo(() => {
                if (!currentSlot) return { percent: 0, color: 'stroke-gray-300', text: '非考試時段' };
                const p = ((currentMs - currentSlot.startMs) / currentSlot.duration) * 100;
                let color = 'stroke-green-500';
                if (currentSlot.remaining < 300000) color = 'stroke-red-500';
                else if (currentSlot.remaining < currentSlot.duration / 2) color = 'stroke-yellow-400';
                return { percent: 100 - p, color, text: currentSlot.type === 'exam' ? (examData.subjects[schedule.filter(s => s.type === 'exam').indexOf(schedule.find(s => s.start === currentSlot.start))] || currentSlot.label) : currentSlot.label };
            }, [currentSlot, currentMs, examData.subjects, schedule]);

            const reminderMessage = useMemo(() => {
                if (!currentSlot) return "請檢查考程設定";
                const list = currentSlot.type === 'exam' ? messages : ["下課準備下一科", "提前喝水上廁所", "坐在位置上準備"];
                const idx = Math.floor(currentMs / 20000) % list.length; // 20秒換一次，絲滑切換
                return list[idx];
            }, [currentSlot, currentMs, messages]);

            return (
                <div className="flex flex-col h-screen w-screen bg-gray-200">
                    
                    {/* 上方：大時間與進度條 */}
                    <div className="h-[30vh] flex bg-white border-b-8 border-gray-300 shadow-xl relative z-10">
                        <div className="w-2/5 flex flex-col items-center justify-center border-r-4 bg-gray-50 relative group">
                            <div className="text-[2vw] text-gray-400 font-black mb-[-1vw]">現在時間</div>
                            <div className="text-[8.5vw] font-black tabular-nums tracking-tighter text-gray-900 leading-none">
                                {adjustedNow.toLocaleTimeString('zh-TW', { hour12: false })}
                            </div>
                            <div className="absolute bottom-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={() => setOffset(o => o - 60000)} className="bg-white border-2 px-3 py-1 rounded font-bold hover:bg-gray-100">-1分</button>
                                <button onClick={() => setOffset(o => o + 60000)} className="bg-white border-2 px-3 py-1 rounded font-bold hover:bg-gray-100">+1分</button>
                                <button onClick={() => setOffset(0)} className="bg-red-500 text-white px-3 py-1 rounded font-bold">重置</button>
                            </div>
                        </div>
                        <div className="w-3/5 flex flex-col items-center justify-center p-8 bg-white relative">
                            <div className="absolute z-10 text-center">
                                <div className="text-[4.5vw] font-black text-gray-800 leading-none mb-2 drop-shadow-sm">{progress.text}</div>
                                <div className="text-[2.2vw] font-bold text-gray-400">
                                    {currentSlot ? `剩餘 ${Math.ceil(currentSlot.remaining/60000)} 分鐘` : '--'}
                                </div>
                            </div>
                            <svg className="w-full h-full" viewBox="0 0 300 60">
                                <rect x="5" y="10" width="290" height="40" rx="20" fill="none" stroke="#f3f4f6" strokeWidth="12" />
                                <rect x="5" y="10" width="290" height="40" rx="20" fill="none" className={`track-transition ${progress.color}`} 
                                    strokeWidth="12" pathLength="100" strokeDasharray="100" strokeDashoffset={100 - progress.percent} strokeLinecap="round" />
                            </svg>
                        </div>
                    </div>

                    <div className="flex-1 flex overflow-hidden">
                        {/* 左側：考程與原始風格出席 */}
                        <div className="w-[60%] flex flex-col border-r-8 border-gray-300 bg-white">
                            <div className="flex-[1.8] overflow-y-auto p-6 space-y-4">
                                {schedule.map((slot, i) => slot.type === 'exam' && (
                                    <div key={i} className={`flex items-center gap-6 p-5 rounded-3xl border-4 transition-all ${currentSlot?.start === slot.start ? 'border-yellow-400 bg-yellow-50 shadow-lg' : 'border-transparent bg-gray-50'}`}>
                                        <input className="w-1/3 text-[4vw] font-black bg-transparent outline-none focus:text-blue-600" 
                                            value={examData.subjects[schedule.filter((_,idx)=>idx<i && schedule[idx].type==='exam').length] || ""} 
                                            onChange={(e) => {
                                                const s = [...examData.subjects]; s[schedule.filter((_,idx)=>idx<i && schedule[idx].type==='exam').length] = e.target.value;
                                                setExamData({...examData, subjects: s});
                                            }} placeholder="科目" />
                                        <div className="flex-1 flex items-center justify-end gap-3 text-[4.5vw] font-black font-mono">
                                            <input type="text" value={slot.start} onChange={(e) => {
                                                const n = [...schedule]; n[i].start = e.target.value; setSchedule(n);
                                            }} className="time-input-flat text-blue-600" placeholder="00:00"/>
                                            <span className="text-gray-400">~</span>
                                            <input type="text" value={slot.end} onChange={(e) => {
                                                const n = [...schedule]; n[i].end = e.target.value; setSchedule(n);
                                            }} className="time-input-flat text-gray-800" placeholder="00:00"/>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* 原始風格：出缺席大方塊區 */}
                            <div className="h-[28vh] flex flex-row border-t-8 border-gray-200">
                                <div className="flex-1 flex flex-col items-center justify-center bg-blue-600 text-white p-2">
                                    <div className="text-[2vw] font-bold opacity-80 uppercase tracking-tighter">應到</div>
                                    <input type="number" className="w-full text-center bg-transparent text-[7vw] font-black outline-none" value={examData.shouldArrive} onChange={(e)=>setExamData({...examData, shouldArrive: e.target.value})} placeholder="0"/>
                                </div>
                                <div className="flex-1 flex flex-col items-center justify-center bg-green-600 text-white p-2 border-l-4 border-white/20">
                                    <div className="text-[2vw] font-bold opacity-80 uppercase tracking-tighter">實到</div>
                                    <input type="number" className="w-full text-center bg-transparent text-[7vw] font-black outline-none" value={examData.actualArrive} onChange={(e)=>setExamData({...examData, actualArrive: e.target.value})} placeholder="0"/>
                                </div>
                                <div className="flex-[1.4] flex flex-col items-center justify-center bg-red-600 text-white p-2 border-l-4 border-white/20">
                                    <div className="text-[1.8vw] font-bold opacity-80 uppercase tracking-tighter">未到座號/姓名</div>
                                    <textarea className="w-full h-full text-center bg-transparent text-[2.5vw] font-black outline-none resize-none pt-2 leading-tight placeholder:text-red-400" value={examData.absentList} onChange={(e)=>setExamData({...examData, absentList: e.target.value})} placeholder="點擊輸入..."/>
                                </div>
                            </div>
                        </div>

                        {/* 右側：提醒看板 (滑動顯示) */}
                        <div className="w-[40%] flex flex-col bg-[#fffdf0] p-6">
                            <div className="flex-1 flex flex-col items-center justify-center border-8 border-dashed border-yellow-200 rounded-[3rem] bg-white p-12 shadow-inner mb-6 relative overflow-hidden">
                                <div className="absolute top-6 left-8 bg-yellow-400 text-white px-5 py-2 rounded-full font-black text-xl shadow-md">提醒事項</div>
                                <div key={reminderMessage} className="text-[5.5vw] font-black text-center leading-tight text-gray-800 animate-fade-in tracking-tight">
                                    {reminderMessage}
                                </div>
                            </div>
                            
                            <div className="h-[30%] overflow-y-auto bg-yellow-50/50 p-5 rounded-3xl border-2 border-yellow-100 shadow-sm">
                                <div className="flex justify-between items-center mb-3">
                                    <div className="text-lg font-black text-yellow-600">編輯輪播內容</div>
                                    <button onClick={()=>setMessages([...messages, "新提醒事項"])} className="bg-yellow-500 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm hover:bg-yellow-600">+ 新增</button>
                                </div>
                                <div className="space-y-3">
                                    {messages.map((m, i) => (
                                        <div key={i} className="flex gap-2">
                                            <input className="flex-1 text-lg p-2 border-2 rounded-xl focus:border-yellow-400 outline-none font-bold shadow-sm bg-white" value={m} onChange={(e)=>{
                                                const n = [...messages]; n[i] = e.target.value; setMessages(n);
                                            }} />
                                            <button onClick={()=>setMessages(messages.filter((_,idx)=>idx!==i))} className="text-red-400 text-2xl font-bold px-2">✕</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期末考看板系統 - 監考欄位版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            overflow: hidden;
            background-color: #f3f4f6;
        }
        .track-transition {
            transition: stroke-dashoffset 1s linear, stroke 0.5s ease;
        }
        /* 編輯框融入背景的樣式 */
        .ghost-input {
            background: transparent;
            border-bottom: 3px solid #e5e7eb;
            transition: all 0.3s;
            padding: 5px;
        }
        .ghost-input:focus {
            border-bottom-color: #3b82f6;
            outline: none;
            background: rgba(255,255,255,0.7);
        }
        /* 專門放大時間輸入框 */
        .big-time-input {
            font-size: 3vw;
            padding: 8px 12px;
            border-radius: 12px;
            border: 2px solid #cbd5e1;
            font-family: 'Consolas', monospace;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const DEFAULT_EXAM_MESSAGES = [
            "考卷記得寫上班級姓名座號",
            "有問題舉手問老師",
            "不會寫的題目先跳過",
            "耐心、細心、小心",
            "寫完多檢查，檢查完再趴下"
        ];

        const DEFAULT_SCHEDULE = [
            { type: 'break', start: '08:30', end: '08:40', label: '準備' },
            { type: 'exam',  start: '08:40', end: '09:20', label: '第一節' },
            { type: 'break', start: '09:20', end: '09:30', label: '下課' },
            { type: 'exam',  start: '09:30', end: '10:10', label: '第二節' },
            { type: 'break', start: '10:10', end: '10:30', label: '下課 (大)' },
            { type: 'exam',  start: '10:30', end: '11:10', label: '第三節' },
            { type: 'break', start: '11:10', end: '11:20', label: '收卷' }
        ];

        const App = () => {
            const [now, setNow] = useState(new Date());
            const [offset, setOffset] = useState(() => Number(localStorage.getItem('exam_clock_offset')) || 0);
            const [schedule, setSchedule] = useState(() => JSON.parse(localStorage.getItem('exam_schedule')) || DEFAULT_SCHEDULE);
            const [examMessages, setExamMessages] = useState(() => JSON.parse(localStorage.getItem('exam_messages')) || DEFAULT_EXAM_MESSAGES);
            
            // 在 examData 中新增 supervisors 陣列
            const [examData, setExamData] = useState(() => JSON.parse(localStorage.getItem('exam_data')) || {
                subjects: ["國語", "數學", "英文"],
                supervisors: ["", "", ""], // 新增：預設監考老師為空
                shouldArrive: "",
                actualArrive: "",
                absentList: ""
            });

            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => { localStorage.setItem('exam_schedule', JSON.stringify(schedule)); }, [schedule]);
            useEffect(() => { localStorage.setItem('exam_messages', JSON.stringify(examMessages)); }, [examMessages]);
            useEffect(() => { localStorage.setItem('exam_data', JSON.stringify(examData)); }, [examData]);
            useEffect(() => { localStorage.setItem('exam_clock_offset', offset); }, [offset]);

            const adjustedNow = useMemo(() => new Date(now.getTime() + offset), [now, offset]);

            const currentSlot = useMemo(() => {
                const currentMs = adjustedNow.getHours() * 3600000 + adjustedNow.getMinutes() * 60000 + adjustedNow.getSeconds() * 1000;
                for (let slot of schedule) {
                    const [sh, sm] = slot.start.split(':').map(Number);
                    const [eh, em] = slot.end.split(':').map(Number);
                    const startMs = sh * 3600000 + sm * 60000;
                    const endMs = eh * 3600000 + em * 60000;
                    if (currentMs >= startMs && currentMs < endMs) {
                        return { ...slot, startMs, endMs, durationMs: endMs - startMs };
                    }
                }
                return null;
            }, [adjustedNow, schedule]);

            const reminderMessage = useMemo(() => {
                if (!currentSlot) return "非考試時段";
                const currentMs = adjustedNow.getHours() * 3600000 + adjustedNow.getMinutes() * 60000 + adjustedNow.getSeconds() * 1000;
                const elapsedMinutes = Math.floor((currentMs - currentSlot.startMs) / 60000);
                const messages = currentSlot.type === 'exam' ? examMessages : ["收拾位置", "準備考試", "坐在位置上"];
                const interval = 5;
                const index = Math.floor(elapsedMinutes / interval) % messages.length;
                return messages[index];
            }, [adjustedNow, currentSlot, examMessages]);

            const progressInfo = useMemo(() => {
                if (!currentSlot) return { remainingPercent: 0, color: 'stroke-gray-300', text: '休息中' };
                const currentMs = adjustedNow.getHours() * 3600000 + adjustedNow.getMinutes() * 60000 + adjustedNow.getSeconds() * 1000;
                const remainingMs = currentSlot.endMs - currentMs;
                const elapsedPercent = Math.min(100, Math.max(0, ((currentMs - currentSlot.startMs) / currentSlot.durationMs) * 100));
                let colorClass = 'stroke-green-500';
                if (remainingMs <= 5 * 60000) colorClass = 'stroke-red-500';
                else if (remainingMs <= currentSlot.durationMs / 2) colorClass = 'stroke-yellow-400';
                return { remainingPercent: 100 - elapsedPercent, color: colorClass, text: currentSlot.label };
            }, [adjustedNow, currentSlot]);

            const updateScheduleTime = (index, field, value) => {
                const newSchedule = [...schedule];
                newSchedule[index][field] = value;
                setSchedule(newSchedule);
            };

            const updateMessage = (index, value) => {
                const newMsgs = [...examMessages];
                newMsgs[index] = value;
                setExamMessages(newMsgs);
            };

            const addMessage = () => setExamMessages([...examMessages, "新提醒事項"]);
            const deleteMessage = (index) => setExamMessages(examMessages.filter((_, i) => i !== index));

            return (
                <div className="flex flex-col h-screen w-screen overflow-hidden text-gray-800">
                    
                    {/* 上方區域 */}
                    <div className="h-[22vh] w-full bg-white border-b-4 border-gray-300 flex flex-row shadow-lg z-10">
                        <div className="w-1/3 flex flex-col items-center justify-center border-r bg-gray-50 group">
                            <div className="text-[1.2vw] text-gray-400 font-bold tracking-widest">現在時間</div>
                            <div className="text-[6.5vw] font-black leading-none tabular-nums">
                                {adjustedNow.toLocaleTimeString('zh-TW', { hour12: false })}
                            </div>
                            <div className="flex gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={() => setOffset(o => o - 60000)} className="px-3 py-1 bg-gray-200 rounded text-sm hover:bg-gray-300">-1分</button>
                                <button onClick={() => setOffset(o => o + 60000)} className="px-3 py-1 bg-gray-200 rounded text-sm hover:bg-gray-300">+1分</button>
                                <button onClick={() => setOffset(0)} className="px-3 py-1 bg-red-100 text-red-600 rounded text-sm hover:bg-red-200">重設</button>
                            </div>
                        </div>

                        <div className="w-2/3 flex flex-col items-center justify-center p-4 bg-gray-100 relative">
                            <div className="absolute z-10 text-[3.5vw] font-black text-gray-700">
                                {progressInfo.text} (剩餘 {Math.ceil((currentSlot?.endMs - (adjustedNow.getHours()*3600000 + adjustedNow.getMinutes()*60000 + adjustedNow.getSeconds()*1000))/60000) || 0} 分)
                            </div>
                            <svg className="w-full h-full" viewBox="0 0 300 60">
                                <rect x="5" y="10" width="290" height="40" rx="20" fill="none" stroke="#e5e7eb" strokeWidth="10" />
                                <rect x="5" y="10" width="290" height="40" rx="20" fill="none" className={`track-transition ${progressInfo.color}`} 
                                    strokeWidth="10" pathLength="100" strokeDasharray="100" strokeDashoffset={100 - progressInfo.remainingPercent} />
                            </svg>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-row">
                        
                        {/* 左側：考程區 */}
                        <div className="w-3/5 flex flex-col border-r-4 border-gray-300 bg-white">
                            <div className="flex-1 overflow-y-auto p-8">
                                <h2 className="text-2xl font-black mb-8 border-l-8 border-blue-500 pl-4 tracking-tighter">考試時間表設定</h2>
                                {schedule.filter(s => s.type === 'exam').map((slot, idx) => {
                                    const realIdx = schedule.findIndex(s => s === slot);
                                    // 確保 supervisors 陣列存在
                                    const supervisors = examData.supervisors || [];
                                    
                                    return (
                                        <div key={idx} className="flex items-center gap-4 mb-8 p-6 bg-blue-50 rounded-2xl shadow-sm border-2 border-blue-100">
                                            {/* 科目欄位 (寬度 w-1/4) */}
                                            <input className="w-1/4 text-[3.5vw] font-black ghost-input text-blue-900" 
                                                value={examData.subjects[idx]} 
                                                placeholder="科目"
                                                onChange={(e) => {
                                                    const s = [...examData.subjects]; s[idx] = e.target.value;
                                                    setExamData({...examData, subjects: s});
                                                }} />
                                                
                                            {/* 新增：監考老師欄位 (寬度 w-1/4) */}
                                            <input className="w-1/4 text-[2.5vw] font-bold ghost-input text-gray-600 text-center" 
                                                value={supervisors[idx] || ""} 
                                                placeholder="監考老師"
                                                onChange={(e) => {
                                                    const s = [...(examData.supervisors || [])]; 
                                                    // 若陣列長度不足則補齊
                                                    while(s.length <= idx) s.push("");
                                                    s[idx] = e.target.value;
                                                    setExamData({...examData, supervisors: s});
                                                }} />

                                            {/* 時間設定 (靠右) */}
                                            <div className="flex-1 flex items-center justify-end gap-3">
                                                <input type="time" className="big-time-input w-[140px]" value={slot.start} 
                                                    onChange={(e) => updateScheduleTime(realIdx, 'start', e.target.value)} />
                                                <span className="text-3xl font-black text-gray-400">~</span>
                                                <input type="time" className="big-time-input w-[140px]" value={slot.end} 
                                                    onChange={(e) => updateScheduleTime(realIdx, 'end', e.target.value)} />
                                            </div>
                                        </div>
                                    );
                                })}

                                <div className="grid grid-cols-3 gap-6 mt-10 h-[28vh]">
                                    <div className="bg-blue-600 p-6 rounded-2xl text-white shadow-xl flex flex-col justify-center">
                                        <div className="text-lg font-bold opacity-80 uppercase tracking-widest text-center">應到人數</div>
                                        <input type="number" className="text-6xl font-black w-full bg-transparent outline-none text-center" value={examData.shouldArrive} onChange={(e)=>setExamData({...examData, shouldArrive: e.target.value})} />
                                    </div>
                                    <div className="bg-green-600 p-6 rounded-2xl text-white shadow-xl flex flex-col justify-center">
                                        <div className="text-lg font-bold opacity-80 uppercase tracking-widest text-center">實到人數</div>
                                        <input type="number" className="text-6xl font-black w-full bg-transparent outline-none text-center" value={examData.actualArrive} onChange={(e)=>setExamData({...examData, actualArrive: e.target.value})} />
                                    </div>
                                    <div className="bg-red-600 p-6 rounded-2xl text-white shadow-xl flex flex-col">
                                        <div className="text-lg font-bold opacity-80 uppercase tracking-widest text-center">缺席名單/座號</div>
                                        <textarea className="text-xl font-black w-full bg-transparent outline-none resize-none flex-1 mt-2 leading-tight placeholder-red-400 text-center" value={examData.absentList} onChange={(e)=>setExamData({...examData, absentList: e.target.value})} placeholder="請輸入座號..." />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 右側：看板區域 */}
                        <div className="w-2/5 bg-[#fffdf0] flex flex-col p-8">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-black border-l-8 border-yellow-500 pl-4 tracking-tighter">提醒內容編輯</h2>
                                <button onClick={addMessage} className="bg-yellow-500 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-yellow-600">+ 新增</button>
                            </div>
                            
                            <div className="flex-1 flex flex-col items-center justify-center border-4 border-dashed border-yellow-200 rounded-[3rem] mb-10 bg-white p-12 shadow-inner relative overflow-hidden">
                                <div className="absolute top-4 left-8 text-xs font-bold text-yellow-500 uppercase tracking-widest opacity-50">Currently Displaying</div>
                                <div key={reminderMessage} className="text-[5vw] font-black text-center text-red-600 leading-tight animate-fade-in drop-shadow-md">
                                    {reminderMessage}
                                </div>
                            </div>

                            <div className="h-1/3 overflow-y-auto space-y-4 pr-4">
                                {examMessages.map((msg, i) => (
                                    <div key={i} className="flex gap-4 group">
                                        <input className="flex-1 p-4 border-2 border-gray-200 rounded-2xl text-lg font-bold bg-white focus:ring-4 focus:ring-yellow-400 outline-none transition-all" value={msg} 
                                            onChange={(e) => updateMessage(i, e.target.value)} />
                                        <button onClick={() => deleteMessage(i)} className="text-gray-300 hover:text-red-500 font-black text-2xl">✕</button>
                                    </div>
                                ))}
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
